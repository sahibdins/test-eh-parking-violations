<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parking Violations Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-white">Parking Violations Lookup</h1>
      <p class="text-sm text-gray-400 mt-1">
        Enter a license plate or driver name to see violations.
      </p>
    </header>

    <!-- Status -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6">
      <div class="flex items-center justify-between gap-4">
        <div>
          <div id="loadStatus" class="text-sm text-gray-400">Loading data...</div>
          <div id="lastUpdated" class="text-xs text-gray-500 mt-1"></div>
        </div>
        <button id="btnReload"
                class="rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700">
          Reload
        </button>
      </div>
    </section>

    <!-- Search -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6 hidden" id="searchSection">
      <div class="grid gap-3 md:grid-cols-3">
        <div>
          <label for="plateQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by License Plate</label>
          <input id="plateQuery" type="text" placeholder="e.g., KS2-447"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div>
          <label for="nameQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by Driver Name</label>
          <input id="nameQuery" type="text" placeholder="e.g., John Doe"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div class="flex items-end">
          <button id="btnSearch" class="w-full md:w-auto rounded-lg bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700">Search</button>
          <button id="btnClear"  class="w-full md:w-auto md:ml-2 rounded-lg bg-gray-600 text-gray-100 px-4 py-2 font-medium hover:bg-gray-500">Clear</button>
        </div>
      </div>

      <!-- Overall paid/unpaid banner -->
      <div id="overallWrap" class="hidden mt-4">
        <div id="overallBadge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"></div>
      </div>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <div class="bg-blue-900 rounded-lg p-3">
          <div class="text-xs text-blue-300">Records loaded</div>
          <div id="statRecords" class="text-xl font-semibold text-blue-100">0</div>
        </div>
        <div class="bg-green-900 rounded-lg p-3">
          <div class="text-xs text-green-300">Matches found</div>
          <div id="statMatches" class="text-xl font-semibold text-green-100">0</div>
        </div>
        <div class="bg-purple-900 rounded-lg p-3">
          <div class="text-xs text-purple-300">Violations for this query</div>
          <div id="statCount" class="text-xl font-semibold text-purple-100">0</div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="resultsWrap" class="bg-gray-800 rounded-xl shadow p-4 hidden">
      <h2 class="text-lg font-semibold mb-3 text-gray-100">Results</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-700 text-gray-200">
            <tr>
              <th class="text-left px-3 py-2">Timestamp</th>
              <th class="text-left px-3 py-2">License Plate</th>
              <th class="text-left px-3 py-2">Driver Name</th>
              <th class="text-left px-3 py-2">Reason for Citation</th>
              <th class="text-left px-3 py-2">Location</th>
              <th class="text-left px-3 py-2">Enforcer</th>
              <th class="text-left px-3 py-2">Status</th>
            </tr>
          </thead>
          <tbody id="resultsBody" class="divide-y divide-gray-700"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQErBNRgH1hcQYmr4hwDiMeAB1-Xwu4AT_2r2dWuWEooMXm80T4dGzhjxzG6OehqOFux2kZDHaIaW3g/pub?output=csv";

    const COLS = {
      timestamp: ["timestamp","time stamp","date","date/time"],
      reason: ["reason for citation","reason","offense","offence"],
      plate: ["license plate #","license plate","plate","plate #","license #"],
      name: ["driver's name (if known)","driver name","student name","name"],
      location: ["parking location:","location","lot"],
      enforcer: ["parking enforcer first and last name:","enforcer","issued by"],
      status: ["status","payment status","paid","is paid","paid?"]
    };

    let DATA = [], HEADMAP = {};
    let lastFetchTime = null;

    const loadStatus  = document.getElementById("loadStatus");
    const lastUpdated = document.getElementById("lastUpdated");
    const searchSection = document.getElementById("searchSection");
    const resultsWrap = document.getElementById("resultsWrap");
    const resultsBody = document.getElementById("resultsBody");
    const statRecords = document.getElementById("statRecords");
    const statMatches = document.getElementById("statMatches");
    const statCount   = document.getElementById("statCount");
    const plateQuery  = document.getElementById("plateQuery");
    const nameQuery   = document.getElementById("nameQuery");
    const overallWrap = document.getElementById("overallWrap");
    const overallBadge= document.getElementById("overallBadge");

    function norm(s){ return String(s||"").trim(); }
    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
    function formatDate(s){
      const d = new Date(s);
      if (isNaN(d)) return s||"";
      const pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function fmtAgo(ms){
      const s = Math.floor(ms/1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ${s%60}s ago`;
      const h = Math.floor(m/60);
      return `${h}h ${m%60}m ago`;
    }
    function updateLastUpdatedDisplay(){
      if (!lastFetchTime) {
        lastUpdated.textContent = "";
        return;
      }
      const now = new Date();
      const ago = now - lastFetchTime;
      const fullDate = lastFetchTime.toLocaleString(); // full date + time
      lastUpdated.textContent = `Last updated: ${fullDate} (${fmtAgo(ago)})`;
    }

    function findKey(header){
      const h = String(header||"").toLowerCase().replace(/\s+/g," ").trim();
      for (const k of Object.keys(COLS)){
        for (const alias of COLS[k]){
          const ha = h.replace(/[^a-z0-9 ]/g,"");
          const aa = alias.replace(/[^a-z0-9 ]/g,"");
          if (ha === aa) return k;
        }
      }
      return null;
    }

    function buildHeadMap(headers){
      HEADMAP = {};
      headers.forEach((h,i) => {
        const key = findKey(h);
        if (key && !(key in HEADMAP)) HEADMAP[key] = i;
      });
      const required = ["timestamp","reason","plate"];
      const missing = required.filter(k => !(k in HEADMAP));
      if (missing.length) throw new Error("Missing required columns: " + missing.join(", "));
    }

    function normalizeRow(row){
      const out = {timestamp:"",reason:"",plate:"",name:"",location:"",enforcer:"",status:""};
      for (const key of Object.keys(HEADMAP)){
        const idx = HEADMAP[key];
        out[key] = norm(row[idx]);
      }
      return out;
    }

    function normalizeStatus(v){
      const s = String(v||"").trim().toLowerCase();
      if (["paid","true","yes","y","1","paid in full"].includes(s)) return "Paid";
      if (["unpaid","false","no","n","0"].includes(s)) return "Unpaid";
      return "Unpaid";
    }

    function statusBadge(status){
      const isPaid = status === "Paid";
      const classes = isPaid
        ? "bg-green-700/70 text-green-100"
        : "bg-red-700/70 text-red-100";
      return `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${classes}">${status}</span>`;
    }

    function handleRecords(headers, rows){
      try { buildHeadMap(headers); }
      catch(e){
        loadStatus.className="text-sm text-red-400";
        loadStatus.textContent = e.message;
        return;
      }
      DATA = rows.map(normalizeRow);
      statRecords.textContent = DATA.length;
      searchSection.classList.remove("hidden");
      resultsWrap.classList.add("hidden");
      loadStatus.className="text-sm text-green-400";
      loadStatus.textContent = "Loaded " + DATA.length + " records.";

      lastFetchTime = new Date();
      updateLastUpdatedDisplay();
    }

    function normalizePlate(s){ return String(s||"").toUpperCase().replace(/[-\s]/g,""); }

    function runSearch(){
      const plateQ = plateQuery.value.trim();
      const nameQ  = nameQuery.value.trim();
      if (!plateQ && !nameQ){
        resultsWrap.classList.add("hidden");
        overallWrap.classList.add("hidden");
        statMatches.textContent = 0;
        statCount.textContent = 0;
        resultsBody.innerHTML = "";
        return;
      }
      const normPlateQ = normalizePlate(plateQ);
      const lcNameQ = nameQ.toLowerCase();

      const matches = DATA.filter(r => {
        let plateOk = true, nameOk = true;
        if (plateQ) plateOk = normalizePlate(r.plate).includes(normPlateQ);
        if (nameQ)  nameOk  = String(r.name||"").toLowerCase().includes(lcNameQ);
        return plateOk && nameOk;
      });

      statMatches.textContent = matches.length;
      statCount.textContent = matches.length;

      let overall = "Unpaid";
      if (matches.length > 0 && matches.every(r => normalizeStatus(r.status) === "Paid")) {
        overall = "Paid";
      }

      overallWrap.classList.remove("hidden");
      overallBadge.className = "inline-flex items-center rounded-full px-3 py-1 text-sm font-medium " +
        (overall === "Paid" ? "bg-green-700/70 text-green-100" : "bg-red-700/70 text-red-100");
      overallBadge.textContent = overall;

      resultsBody.innerHTML = "";
      for (const r of matches){
        const st = normalizeStatus(r.status);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHtml(formatDate(r.timestamp))}</td>
          <td class="px-3 py-2 font-semibold">${escapeHtml(r.plate)}</td>
          <td class="px-3 py-2">${escapeHtml(r.name)}</td>
          <td class="px-3 py-2">${escapeHtml(r.reason)}</td>
          <td class="px-3 py-2">${escapeHtml(r.location || "")}</td>
          <td class="px-3 py-2">${escapeHtml(r.enforcer || "")}</td>
          <td class="px-3 py-2">${statusBadge(st)}</td>`;
        resultsBody.appendChild(tr);
      }
      resultsWrap.classList.remove("hidden");
    }

    function loadFromCsv(){
      loadStatus.className="text-sm text-gray-400";
      loadStatus.textContent="Fetching data...";
      Papa.parse(CSV_URL, {
        download: true,
        skipEmptyLines: true,
        complete: (res) => {
          const rows = (res.data||[]).filter(r => Array.isArray(r) && r.some(c => String(c||"").trim()!==""));
          if (!rows.length){
            loadStatus.className="text-sm text-red-400";
            loadStatus.textContent="CSV appears empty.";
            return;
          }
          const headers = rows[0].map(norm);
          const body = rows.slice(1);
          handleRecords(headers, body);
        },
        error: () => {
          loadStatus.className="text-sm text-red-400";
          loadStatus.textContent="Could not fetch/parse CSV.";
        }
      });
    }

    document.getElementById("btnReload").addEventListener("click", loadFromCsv);
    document.getElementById("btnSearch").addEventListener("click", runSearch);
    document.getElementById("btnClear").addEventListener("click", () => {
      plateQuery.value=""; nameQuery.value="";
      resultsBody.innerHTML="";
      resultsWrap.classList.add("hidden");
      overallWrap.classList.add("hidden");
      statMatches.textContent=0; statCount.textContent=0;
    });
    plateQuery.addEventListener("keyup", e => { if (e.key==="Enter") runSearch(); });
    nameQuery.addEventListener("keyup", e => { if (e.key==="Enter") runSearch(); });

    // Initial load
    loadFromCsv();

    // Auto-refresh data every 30 seconds
    setInterval(() => {
      loadFromCsv();
    }, 30000);

    // Update "last updated" display every second
    setInterval(updateLastUpdatedDisplay, 1000);
  </script>
</body>
</html>
