<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parking Violations Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100">

  <!-- ACCESS GATE OVERLAY (outside allowed hours unless admin override) -->
  <div id="accessGate" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80"></div>
    <div class="relative z-10 h-full w-full flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-white">Access Restricted</h2>
        <p class="text-sm text-gray-300 mt-2">
          This site is available between <span class="font-medium">7:45 AM</span> and
          <span class="font-medium">3:15 PM</span> Eastern. Please try again during those hours.
        </p>
        <div class="mt-5">
          <label for="gatePwd" class="block text-sm text-gray-200 mb-2">Admin override password</label>
          <input id="gatePwd" type="password" placeholder="Enter password"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
          <button id="gateUnlock"
                  class="mt-3 w-full rounded-lg bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700">
            Unlock
          </button>
          <div id="gateMsg" class="text-xs text-red-400 mt-2"></div>
        </div>
        <div class="mt-4 text-xs text-gray-400" id="gateNow"></div>
      </div>
    </div>
  </div>

  <div class="max-w-5xl mx-auto p-6" id="appRoot">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-white">Parking Violations Lookup</h1>
      <p class="text-sm text-gray-400 mt-1">
        Enter a license plate or driver name to see violations.
      </p>
    </header>

    <!-- Status + Refresh + Admin Lock -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6">
      <div class="flex flex-col gap-3">
        <div class="flex items-center justify-between gap-4">
          <div>
            <div id="loadStatus" class="text-sm text-gray-400">Loading data...</div>
            <details class="text-xs text-gray-400 mt-1" id="errDetails" style="display:none;">
              <summary class="cursor-pointer">Error details</summary>
              <pre id="errText" class="mt-1 whitespace-pre-wrap"></pre>
            </details>
            <div id="lastUpdated" class="text-xs text-gray-500 mt-1"></div>
          </div>
          <button id="btnReload"
                  class="rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700">
            Reload
          </button>
        </div>

        <!-- Admin controls -->
        <div class="flex flex-wrap items-center gap-2">
          <span id="adminState" class="text-xs rounded-full px-2 py-1 bg-gray-700 text-gray-200">Admin: Locked</span>
          <input id="enforcerPwd" type="password" placeholder="Enter password"
                 class="rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-emerald-500" />
          <button id="btnUnlock"
                  class="rounded-lg bg-blue-600 text-white px-3 py-2 text-sm font-medium hover:bg-blue-700">
            Unlock
          </button>
          <button id="btnLock"
                  class="rounded-lg bg-gray-600 text-white px-3 py-2 text-sm font-medium hover:bg-gray-500 hidden">
            Lock
          </button>

          <!-- Admin-only Print Report trigger -->
          <button id="btnPrintOpen"
                  class="rounded-lg bg-indigo-600 text-white px-3 py-2 text-sm font-medium hover:bg-indigo-700 hidden">
            Print Report
          </button>

          <span id="enforcerMsg" class="text-xs text-red-400"></span>
        </div>
      </div>
    </section>

    <!-- Search + Filters -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6 hidden" id="searchSection">
      <div class="grid gap-3 md:grid-cols-6">
        <div class="md:col-span-3">
          <label for="plateQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by License Plate</label>
          <input id="plateQuery" type="text" placeholder="e.g., KS2-447"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div class="md:col-span-3">
          <label for="nameQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by Driver Name</label>
          <input id="nameQuery" type="text" placeholder="e.g., John Doe"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
      </div>

      <!-- Advanced filters: hidden until admin unlock -->
      <div id="advancedFilters" class="hidden">
        <div class="grid gap-3 md:grid-cols-6 mt-3">
          <div>
            <label for="statusFilter" class="block text-sm font-medium text-gray-200 mb-2">Filter by Status</label>
            <select id="statusFilter"
                    class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500">
              <option value="all">All</option>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
              <option value="excempt">Excempt</option>
            </select>
          </div>
          <div>
            <label for="lotFilter" class="block text-sm font-medium text-gray-200 mb-2">Filter by Parking Lot</label>
            <select id="lotFilter"
                    class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500">
              <option value="all">All lots</option>
            </select>
          </div>
          <div>
            <label for="repeatFilter" class="block text-sm font-medium text-gray-200 mb-2">Repeat Offenders</label>
            <select id="repeatFilter"
                    class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500">
              <option value="all">All</option>
              <option value="repeat">More than 1 violation</option>
            </select>
          </div>
        </div>

        <!-- Date + Hang Tag row (admin) -->
        <div class="grid gap-3 md:grid-cols-6 mt-3">
          <div class="md:col-span-2">
            <label for="dateFrom" class="block text-sm font-medium text-gray-200 mb-2">From (date)</label>
            <input id="dateFrom" type="date"
                   class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
          </div>
          <div class="md:col-span-2">
            <label for="dateTo" class="block text-sm font-medium text-gray-200 mb-2">To (date)</label>
            <input id="dateTo" type="date"
                   class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
          </div>
          <div class="md:col-span-2">
            <label for="hangQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by Hang Tag (admin)</label>
            <input id="hangQuery" type="text" placeholder="e.g., 1234"
                   class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
          </div>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnSearch" class="rounded-lg bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700">Search</button>
        <button id="btnApplyDates" class="rounded-lg bg-purple-600 text-white px-4 py-2 font-medium hover:bg-purple-700">Apply Dates</button>
        <button id="btnClear"  class="rounded-lg bg-gray-600 text-gray-100 px-4 py-2 font-medium hover:bg-gray-500">Clear</button>
      </div>

      <!-- Overall paid/unpaid/excempt banner -->
      <div id="overallWrap" class="hidden mt-4">
        <div id="overallBadge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"></div>
      </div>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <div class="bg-blue-900 rounded-lg p-3">
          <div class="text-xs text-blue-300">Records loaded</div>
          <div id="statRecords" class="text-xl font-semibold text-blue-100">0</div>
        </div>
        <div class="bg-green-900 rounded-lg p-3">
          <div class="text-xs text-green-300">Matches (after filters)</div>
          <div id="statMatches" class="text-xl font-semibold text-green-100">0</div>
        </div>
        <div class="bg-purple-900 rounded-lg p-3">
          <div class="text-xs text-purple-300">Violations for this query</div>
          <div id="statCount" class="text-xl font-semibold text-purple-100">0</div>
        </div>
      </div>
    </section>

    <!-- Ticket Submission Form Link (student-facing) -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6">
      <h2 class="text-lg font-semibold text-white mb-3">Submit a Parking Violation</h2>
      <p class="text-sm text-gray-400 mb-4">
        Use the form below to submit a new parking violation ticket.
      </p>
      <a href="https://forms.gle/WcwMUCiZMMpW4Mkt5" target="_blank" rel="noopener"
         class="inline-flex items-center rounded-lg bg-indigo-600 text-white px-5 py-2 font-medium hover:bg-indigo-700">
        Open Ticket Form
      </a>
    </section>

    <!-- Results -->
    <section id="resultsWrap" class="bg-gray-800 rounded-xl shadow p-4 hidden">
      <h2 class="text-lg font-semibold mb-3 text-gray-100" id="resultsTitle">Results</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-700 text-gray-200">
            <tr id="resultsHeaderRow"></tr>
          </thead>
          <tbody id="resultsBody" class="divide-y divide-gray-700"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- PRINT REPORT MODAL (admin) -->
  <div id="printModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="relative z-10 h-full w-full flex items-center justify-center p-4">
      <div class="w-full max-w-lg bg-gray-800 rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-white">Print Report</h3>
          <button id="printClose" class="text-gray-300 hover:text-white text-xl leading-none">&times;</button>
        </div>
        <div class="mt-4 grid gap-4">
          <div>
            <label class="block text-sm text-gray-200 mb-2" for="printType">Report type</label>
            <select id="printType"
                    class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-indigo-500">
              <option value="current">Current filters</option>
              <option value="paid">Paid only</option>
              <option value="unpaid">Unpaid only</option>
              <option value="repeat">Repeat offenders (aggregated)</option>
              <option value="lot">By lot (use current lot)</option>
              <option value="date">By date range (use current)</option>
            </select>
            <p class="text-xs text-gray-400 mt-2">
              Note: “By lot” and “By date range” use your current selections in the filters.
            </p>
          </div>
          <div class="flex items-center justify-end gap-2">
            <button id="printCancel"
                    class="rounded-lg bg-gray-600 text-white px-4 py-2 text-sm hover:bg-gray-500">
              Cancel
            </button>
            <button id="printGo"
                    class="rounded-lg bg-indigo-600 text-white px-4 py-2 text-sm hover:bg-indigo-700">
              Generate & Print
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CSV_BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQErBNRgH1hcQYmr4hwDiMeAB1-Xwu4AT_2r2dWuWEooMXm80T4dGzhjxzG6OehqOFux2kZDHaIaW3g/pub?output=csv";
    const CSV_URL = () => `${CSV_BASE}&_=${Date.now()}`; // cache-buster

    const COLS = {
      timestamp: ["timestamp","time stamp","date","date/time"],
      reason: ["reason for citation","reason","offense","offence"],
      plate: ["license plate #","license plate","plate","plate #","license #"],
      name: ["driver's name (if known)","driver name","student name","name"],
      location: ["parking location:","location","lot"],
      enforcer: ["parking enforcer first and last name:","enforcer","issued by"],
      status: ["status","payment status","paid","is paid","paid?"],
      hangtag: ["hang tag number","hangtag","hang tag","tag","tag number","hang-tag","hangtag #","hang tag #"]
    };

    let DATA = [], HEADMAP = {};
    let lastFetchTime = null;

    // Admin state controls admin-only UI + columns
    let isAdmin = false;

    // ACCESS GATE state (time-based overlay)
    let adminOverride = false;

    // Best driver name per normalized plate
    let bestNameByPlate = {};

    // Elements
    const loadStatus  = document.getElementById("loadStatus");
    const errDetails  = document.getElementById("errDetails");
    const errText     = document.getElementById("errText");
    const lastUpdated = document.getElementById("lastUpdated");
    const searchSection = document.getElementById("searchSection");
    const resultsWrap = document.getElementById("resultsWrap");
    const resultsTitle= document.getElementById("resultsTitle");
    const resultsBody = document.getElementById("resultsBody");
    const statRecords = document.getElementById("statRecords");
    const statMatches = document.getElementById("statMatches");
    const statCount   = document.getElementById("statCount");
    const plateQuery  = document.getElementById("plateQuery");
    const nameQuery   = document.getElementById("nameQuery");
    const statusFilter= document.getElementById("statusFilter");
    const lotFilter   = document.getElementById("lotFilter");
    const repeatFilter= document.getElementById("repeatFilter");
    const dateFromEl  = document.getElementById("dateFrom");
    const dateToEl    = document.getElementById("dateTo");
    const hangQuery   = document.getElementById("hangQuery");
    const overallWrap = document.getElementById("overallWrap");
    const overallBadge= document.getElementById("overallBadge");
    const advancedFilters = document.getElementById("advancedFilters");
    const headerRow    = document.getElementById("resultsHeaderRow");

    // Admin controls
    const enforcerPwd  = document.getElementById("enforcerPwd");
    const btnUnlock    = document.getElementById("btnUnlock");
    const btnLock      = document.getElementById("btnLock");
    const enforcerMsg  = document.getElementById("enforcerMsg");
    const adminState   = document.getElementById("adminState");
    const btnPrintOpen = document.getElementById("btnPrintOpen");

    // Print modal
    const printModal  = document.getElementById("printModal");
    const printClose  = document.getElementById("printClose");
    const printCancel = document.getElementById("printCancel");
    const printGo     = document.getElementById("printGo");
    const printType   = document.getElementById("printType");

    // Access gate controls
    const accessGate = document.getElementById("accessGate");
    const gatePwd    = document.getElementById("gatePwd");
    const gateUnlock = document.getElementById("gateUnlock");
    const gateMsg    = document.getElementById("gateMsg");
    const gateNow    = document.getElementById("gateNow");

    function norm(s){ return String(s||"").trim(); }
    function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
    function formatDate(s){
      const d = new Date(s);
      if (isNaN(d)) return s||"";
      const pad=n=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function fmtAgo(ms){
      const s = Math.floor(ms/1000);
      if (s < 60) return `${s}s ago`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m}m ${s%60}s ago`;
      const h = Math.floor(m/60);
      return `${h}h ${m%60}m ago`;
    }
    function updateLastUpdatedDisplay(){
      if (!lastFetchTime) { lastUpdated.textContent = ""; return; }
      const now = new Date();
      const ago = now - lastFetchTime;
      const fullDate = lastFetchTime.toLocaleString();
      lastUpdated.textContent = `Last updated: ${fullDate} (${fmtAgo(ago)})`;
    }

    function findKey(header){
      const h = String(header||"").toLowerCase().replace(/\s+/g," ").trim();
      for (const k of Object.keys(COLS)){
        for (const alias of COLS[k]){
          const ha = h.replace(/[^a-z0-9 ]/g,"");
          const aa = alias.replace(/[^a-z0-9 ]/g,"");
          if (ha === aa) return k;
        }
      }
      return null;
    }
    function buildHeadMap(headers){
      HEADMAP = {};
      headers.forEach((h,i) => {
        const key = findKey(h);
        if (key && !(key in HEADMAP)) HEADMAP[key] = i;
      });
      const required = ["timestamp","reason","plate"];
      const missing = required.filter(k => !(k in HEADMAP));
      if (missing.length) throw new Error("Missing required columns: " + missing.join(", "));
    }
    function normalizeRow(row){
      const out = {timestamp:"",reason:"",plate:"",name:"",location:"",enforcer:"",status:"",hangtag:""};
      for (const key of Object.keys(HEADMAP)){
        const idx = HEADMAP[key];
        out[key] = norm(row[idx]);
      }
      return out;
    }

    // Map status inputs to three states: Paid / Unpaid / Excempt
    function normalizeStatus(v){
      const s = String(v||"").trim().toLowerCase();
      if (["3","excempt","exempt"].includes(s)) return "Excempt";
      if (["paid","true","yes","y","1","paid in full"].includes(s)) return "Paid";
      if (["unpaid","false","no","n","0",""].includes(s)) return "Unpaid";
      return "Unpaid";
    }

    function statusBadge(status){
      if (status === "Paid")   return `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-green-700/70 text-green-100">Paid</span>`;
      if (status === "Excempt")return `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-yellow-600/70 text-yellow-100">Excempt</span>`;
      return `<span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-red-700/70 text-red-100">Unpaid</span>`;
    }

    function normalizePlate(s){ return String(s||"").toUpperCase().replace(/[-\s]/g,""); }
    function normalizeHang(s){ return String(s||"").toUpperCase().replace(/[^A-Z0-9]/g,""); }

    // Placeholder names to ignore
    function isPlaceholderName(s){
      const t = String(s||"").trim();
      if (!t) return true;
      const l = t.toLowerCase();
      return ["n/a","na","none","-","unknown","not listed","nil","n\\a","n.a."].includes(l);
    }

    // Build best display name per plate across ALL rows
    function buildBestNameMap(){
      const tally = {};
      for (const r of DATA){
        const plateKey = normalizePlate(r.plate);
        const raw = String(r.name||"").trim();
        if (isPlaceholderName(raw)) continue;
        const key = raw.toLowerCase();
        if (!tally[plateKey]) tally[plateKey] = {};
        if (!tally[plateKey][key]) tally[plateKey][key] = { count: 0, display: raw };
        tally[plateKey][key].count += 1;
      }
      const best = {};
      for (const plateKey of Object.keys(tally)){
        let bestName = "", bestCount = 0;
        for (const k of Object.keys(tally[plateKey])){
          const { count, display } = tally[plateKey][k];
          if (count > bestCount){ bestCount = count; bestName = display; }
        }
        if (bestName) best[plateKey] = bestName;
      }
      bestNameByPlate = best;
    }

    // Header builders
    function renderHeaderDetailed(){
      headerRow.innerHTML = `
        <th class="text-left px-3 py-2">Timestamp</th>
        <th class="text-left px-3 py-2">License Plate</th>
        <th class="text-left px-3 py-2">Driver Name</th>
        <th class="text-left px-3 py-2">Reason for Citation</th>
        <th class="text-left px-3 py-2">Location</th>
        ${isAdmin ? '<th class="text-left px-3 py-2">Hang Tag</th>' : ''}
        ${isAdmin ? '<th class="text-left px-3 py-2">Enforcer</th>' : ''}
        <th class="text-left px-3 py-2">Status</th>
      `;
      resultsTitle.textContent = "Results";
    }
    function renderHeaderAggregated(){
      headerRow.innerHTML = `
        <th class="text-left px-3 py-2">License Plate</th>
        <th class="text-left px-3 py-2">Driver Name</th>
        <th class="text-left px-3 py-2">Offences</th>
      `;
      resultsTitle.textContent = "Repeat Offenders";
    }

    function populateLotFilter(){
      const prev = lotFilter.value || "all";
      const set = new Set();
      for (const r of DATA){
        const loc = String(r.location || "").trim();
        if (loc) set.add(loc);
      }
      const options = ["all", ...Array.from(set).sort((a,b)=>a.localeCompare(b))];
      lotFilter.innerHTML = options.map(v => {
        const label = v === "all" ? "All lots" : v;
        const sel = v === prev ? "selected" : "";
        return `<option value="${escapeHtml(v)}" ${sel}>${escapeHtml(label)}</option>`;
      }).join("");
    }

    function handleRecords(headers, rows){
      try { buildHeadMap(headers); }
      catch(e){ showError(e); return; }
      DATA = rows.map(normalizeRow);
      statRecords.textContent = DATA.length;
      searchSection.classList.remove("hidden");
      resultsWrap.classList.add("hidden");
      setStatusOk(`Loaded ${DATA.length} records.`);
      populateLotFilter();
      buildBestNameMap();
      lastFetchTime = new Date();
      updateLastUpdatedDisplay();
    }

    // Date helpers
    function parseDateOnlyInput(value){
      if (!value) return null;
      const [y,m,d] = value.split("-").map(n => parseInt(n,10));
      if (!y || !m || !d) return null;
      return new Date(y, m-1, d, 0, 0, 0, 0);
    }
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }
    function endOfDay(d){   return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23,59,59,999); }
    function recordInDateRange(recTs, fromDate, toDate){
      if (!fromDate && !toDate) return true;
      const d = new Date(recTs);
      if (isNaN(d)) return false;
      const t = d.getTime();
      if (fromDate && t < startOfDay(fromDate).getTime()) return false;
      if (toDate   && t > endOfDay(toDate).getTime())   return false;
      return true;
    }

    // Local “most common non-empty” (ignoring placeholders)
    function mostCommonNonEmpty(values){
      const counts = {};
      let best = "", bestCount = 0;
      for (const v of values){
        if (isPlaceholderName(v)) continue;
        const s = String(v||"").trim();
        if (!s) continue;
        const key = s.toLowerCase();
        counts[key] = counts[key] ? { count: counts[key].count + 1, display: s } : { count: 1, display: s };
        if (counts[key].count > bestCount){ best = counts[key].display; bestCount = counts[key].count; }
      }
      return best;
    }

    function renderResultsDetailed(matches){
      renderHeaderDetailed();
      resultsBody.innerHTML = "";
      for (const r of matches){
        const st = normalizeStatus(r.status);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHtml(formatDate(r.timestamp))}</td>
          <td class="px-3 py-2 font-semibold">${escapeHtml(r.plate)}</td>
          <td class="px-3 py-2">${escapeHtml(r.name)}</td>
          <td class="px-3 py-2">${escapeHtml(r.reason)}</td>
          <td class="px-3 py-2">${escapeHtml(r.location || "")}</td>
          ${isAdmin ? `<td class="px-3 py-2">${escapeHtml(r.hangtag || "")}</td>` : ``}
          ${isAdmin ? `<td class="px-3 py-2">${escapeHtml(r.enforcer || "")}</td>` : ``}
          <td class="px-3 py-2">${statusBadge(st)}</td>
        `;
        resultsBody.appendChild(tr);
      }
      resultsWrap.classList.remove("hidden");
    }

    function renderResultsAggregated(matches){
      const groups = new Map(); // key -> {plateForms:[], names:[], count}
      for (const r of matches){
        const key = normalizePlate(r.plate);
        if (!groups.has(key)) groups.set(key, { plateForms: [], names: [], count: 0 });
        const g = groups.get(key);
        g.count += 1;
        g.plateForms.push(String(r.plate||"").trim());
        g.names.push(String(r.name||"").trim());
      }
      const agg = [];
      for (const [key, g] of groups.entries()){
        if (g.count > 1){
          const displayPlate = mostCommonNonEmpty(g.plateForms) || key;
          const globalBest = bestNameByPlate[key] || "";
          const localBest  = mostCommonNonEmpty(g.names);
          const displayName = globalBest || localBest || "";
          agg.push({ plate: displayPlate, name: displayName, count: g.count, key });
        }
      }
      renderHeaderAggregated();
      resultsBody.innerHTML = "";
      for (const row of agg.sort((a,b)=> b.count - a.count || a.plate.localeCompare(b.plate))){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-3 py-2 font-semibold">${escapeHtml(row.plate)}</td>
          <td class="px-3 py-2">${escapeHtml(row.name)}</td>
          <td class="px-3 py-2">${row.count}</td>
        `;
        resultsBody.appendChild(tr);
      }
      resultsWrap.classList.remove("hidden");
      statMatches.textContent = agg.length;
      const total = agg.reduce((s,x)=>s+x.count,0);
      statCount.textContent = total;
      overallWrap.classList.add("hidden");
    }

    // Core filtering used for both on-screen results and printing
    function getFilteredRows(opts = {}){
      const plateQ = (opts.plateQ ?? plateQuery.value).trim();
      const nameQ  = (opts.nameQ  ?? nameQuery.value).trim();
      const statusF= opts.statusF ?? (isAdmin ? statusFilter.value : 'all');
      const lotF   = opts.lotF    ?? (isAdmin ? lotFilter.value : 'all');
      const repeatF= opts.repeatF ?? (isAdmin ? repeatFilter.value : 'all');
      const fromD  = opts.fromD   ?? (isAdmin ? parseDateOnlyInput(dateFromEl.value) : null);
      const toD    = opts.toD     ?? (isAdmin ? parseDateOnlyInput(dateToEl.value)   : null);
      const hangQ  = (opts.hangQ  ?? (isAdmin ? hangQuery.value : "")).trim();

      const normPlateQ = normalizePlate(plateQ);
      const lcNameQ = nameQ.toLowerCase();
      const lotSel = String(lotF || "").toLowerCase();
      const normHangQ = normalizeHang(hangQ);

      const rows = DATA.filter(r => {
        let plateOk = true, nameOk = true, statusOk = true, dateOk = true, lotOk = true, hangOk = true;

        if (plateQ) plateOk = normalizePlate(r.plate).includes(normPlateQ);
        if (nameQ)  nameOk  = String(r.name||"").toLowerCase().includes(lcNameQ);
        if (statusF !== 'all') statusOk = normalizeStatus(r.status) ===
            (statusF === 'paid' ? 'Paid' : statusF === 'excempt' ? 'Excempt' : 'Unpaid');
        if (fromD || toD)      dateOk = recordInDateRange(r.timestamp, fromD, toD);
        if (lotF !== 'all')    lotOk  = String(r.location||"").toLowerCase().trim() === lotSel;
        if (hangQ)             hangOk = normalizeHang(r.hangtag).includes(normHangQ);

        return plateOk && nameOk && statusOk && dateOk && lotOk && hangOk;
      });

      return { rows, repeatF, statusF, lotF, fromD, toD };
    }

    function runSearch(){
      const { rows: matchesPre, repeatF } = getFilteredRows();

      if (!plateQuery.value && !nameQuery.value && repeatF === 'all'
          && (!isAdmin || (statusFilter.value === 'all' && lotFilter.value === 'all' && !dateFromEl.value && !dateToEl.value && !hangQuery.value))){
        resultsWrap.classList.add("hidden");
        overallWrap.classList.add("hidden");
        statMatches.textContent = 0;
        statCount.textContent = 0;
        resultsBody.innerHTML = "";
        return;
      }

      if (repeatF !== 'repeat'){
        statMatches.textContent = matchesPre.length;
        statCount.textContent = matchesPre.length;

        // Overall badge: Paid if all Paid; Excempt if all Excempt; else Unpaid
        let overall = "Unpaid";
        if (matchesPre.length > 0) {
          const allPaid = matchesPre.every(r => normalizeStatus(r.status) === "Paid");
          const allEx   = matchesPre.every(r => normalizeStatus(r.status) === "Excempt");
          overall = allPaid ? "Paid" : allEx ? "Excempt" : "Unpaid";
        }
        overallWrap.classList.remove("hidden");
        overallBadge.className = "inline-flex items-center rounded-full px-3 py-1 text-sm font-medium " +
          (overall === "Paid" ? "bg-green-700/70 text-green-100"
           : overall === "Excempt" ? "bg-yellow-600/70 text-yellow-100"
           : "bg-red-700/70 text-red-100");
        overallBadge.textContent = overall;

        renderResultsDetailed(matchesPre);
        return;
      }

      // Repeat mode aggregated
      const plateCounts = {};
      for (const r of matchesPre){
        const k = normalizePlate(r.plate);
        plateCounts[k] = (plateCounts[k] || 0) + 1;
      }
      const repeatRows = matchesPre.filter(r => plateCounts[normalizePlate(r.plate)] > 1);
      renderResultsAggregated(repeatRows);
    }

    function setStatusOk(msg){
      errDetails.style.display = "none";
      errText.textContent = "";
      loadStatus.className = "text-sm text-green-400";
      loadStatus.textContent = msg;
    }
    function showError(err){
      loadStatus.className = "text-sm text-red-400";
      loadStatus.textContent = "Could not fetch/parse CSV.";
      errDetails.style.display = "";
      errText.textContent = String(err && err.stack ? err.stack : err);
    }

    // Robust loader
    async function loadFromCsv(){
      loadStatus.className="text-sm text-gray-400";
      loadStatus.textContent="Fetching data...";
      errDetails.style.display = "none";
      errText.textContent = "";

      try {
        const res = await fetch(CSV_URL(), { cache: "no-store", mode: "cors" });
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const csvText = await res.text();
        const parsed = Papa.parse(csvText, { skipEmptyLines: true });
        if (parsed.errors && parsed.errors.length) throw new Error(parsed.errors.map(e => e.message).join("; "));
        const rows = (parsed.data||[]).filter(r => Array.isArray(r) && r.some(c => String(c||"").trim()!==""));
        if (!rows.length) throw new Error("CSV appears empty.");
        const headers = rows[0].map(norm);
        const body = rows.slice(1);
        handleRecords(headers, body);
      } catch (err) {
        showError(err);
      } finally {
        lastFetchTime = new Date();
        updateLastUpdatedDisplay();
      }
    }

    // Admin UI state
    function updateAdminUI(){
      adminState.textContent = isAdmin ? "Admin: Unlocked" : "Admin: Locked";
      adminState.className = "text-xs rounded-full px-2 py-1 " + (isAdmin ? "bg-green-700 text-green-100" : "bg-gray-700 text-gray-200");
      btnUnlock.classList.toggle("hidden", isAdmin);
      enforcerPwd.classList.toggle("hidden", isAdmin);
      btnLock.classList.toggle("hidden", !isAdmin);
      btnPrintOpen.classList.toggle("hidden", !isAdmin); // show Print button only to admins

      advancedFilters.classList.toggle("hidden", !isAdmin);
      if (isAdmin && repeatFilter.value === 'repeat') renderHeaderAggregated();
      else renderHeaderDetailed();
    }

    btnUnlock.addEventListener("click", () => {
      enforcerMsg.textContent = "";
      const val = enforcerPwd.value.trim();
      if (val === "002821"){
        isAdmin = true;
        updateAdminUI();
        runSearch();
        enforcerPwd.value = "";
      } else {
        enforcerMsg.textContent = "Incorrect password.";
      }
    });
    btnLock.addEventListener("click", () => {
      isAdmin = false;
      statusFilter.value = "all";
      lotFilter.value = "all";
      repeatFilter.value = "all";
      dateFromEl.value = "";
      dateToEl.value = "";
      hangQuery.value = "";
      updateAdminUI();
      runSearch();
    });

    // ===== Access Gate (time restriction in America/New_York) =====
    function nyNowParts(){
      const fmt = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/New_York",
        hour12: false,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
      const parts = fmt.formatToParts(new Date());
      const map = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return {
        y: parseInt(map.year,10), m: parseInt(map.month,10), d: parseInt(map.day,10),
        hh: parseInt(map.hour,10), mm: parseInt(map.minute,10), ss: parseInt(map.second,10),
        label: `${map.month}/${map.day}/${map.year} ${map.hour}:${map.minute}:${map.second} ET`
      };
    }
    function nyMinutesSinceMidnight(){ const p = nyNowParts(); return p.hh*60 + p.mm; }
    function withinAllowedWindow(){ const mins = nyMinutesSinceMidnight(); return mins >= 465 && mins <= 915; } // 07:45–15:15
    function updateGateNowLabel(){ const p = nyNowParts(); gateNow.textContent = `Current time: ${p.label}`; }
    function showGate(){ accessGate.classList.remove("hidden"); updateGateNowLabel(); }
    function hideGate(){ accessGate.classList.add("hidden"); }
    function checkAccessGate(){ if (adminOverride) { hideGate(); return; } if (withinAllowedWindow()) hideGate(); else showGate(); }
    gateUnlock.addEventListener("click", () => {
      gateMsg.textContent = "";
      const val = gatePwd.value.trim();
      if (val === "002821") {
        adminOverride = true;
        sessionStorage.setItem("adminOverride","1");
        hideGate();
        gatePwd.value = "";
      } else {
        gateMsg.textContent = "Incorrect password.";
      }
    });
    if (sessionStorage.getItem("adminOverride") === "1") adminOverride = true;

    // ===== Print Modal controls =====
    btnPrintOpen.addEventListener("click", () => { printModal.classList.remove("hidden"); });
    printClose.addEventListener("click", () => { printModal.classList.add("hidden"); });
    printCancel.addEventListener("click", () => { printModal.classList.add("hidden"); });
    printModal.addEventListener("click", (e) => { if (e.target === printModal) printModal.classList.add("hidden"); });

    printGo.addEventListener("click", () => {
      const type = printType.value;
      let opts = {};
      if (type === "paid")   opts = { statusF: "paid" };
      if (type === "unpaid") opts = { statusF: "unpaid" };
      if (type === "lot")    opts = { lotF: lotFilter.value };
      if (type === "date")   opts = { fromD: parseDateOnlyInput(dateFromEl.value), toD: parseDateOnlyInput(dateToEl.value) };

      const { rows, fromD, toD, lotF } = getFilteredRows(opts);

      const nowLabel = new Date().toLocaleString();
      let title = "Report – ";
      if (type === "current") title += "Current Filters";
      if (type === "paid")    title += "Paid Only";
      if (type === "unpaid")  title += "Unpaid Only";
      if (type === "lot")     title += `By Lot (${lotF})`;
      if (type === "date")    title += `By Date${fromD ? " from "+fromD.toLocaleDateString() : ""}${toD ? " to "+toD.toLocaleDateString() : ""}`;
      if (type === "repeat")  title += "Repeat Offenders (Aggregated)";

      const win = window.open("", "_blank");
      if (!win) { alert("Popup blocked. Please allow popups to generate the report."); return; }

      const style = `
        <style>
          *{ box-sizing:border-box; }
          body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; color:#111; margin:24px; }
          h1{ font-size:20px; margin:0 0 8px; }
          .meta{ color:#444; font-size:12px; margin-bottom:16px; }
          table{ width:100%; border-collapse: collapse; }
          th, td{ text-align:left; border-bottom:1px solid #ddd; padding:8px 10px; font-size:12px; }
          th{ background:#f3f4f6; }
          .badge{ display:inline-block; padding:2px 8px; border-radius:9999px; font-size:11px; color:#fff; }
          .paid{ background:#16a34a; }
          .unpaid{ background:#dc2626; }
          .excempt{ background:#d97706; } /* amber-600 */
          @media print {
            @page { size: auto; margin: 12mm; }
            body{ margin:0; }
          }
        </style>
      `;

      let html = `<html><head><title>${escapeHtml(title)}</title>${style}</head><body>`;
      html += `<h1>${escapeHtml(title)}</h1>`;
      html += `<div class="meta">Generated: ${escapeHtml(nowLabel)}</div>`;

      if (type === "repeat"){
        const counts = {};
        const plateForms = {};
        for (const r of rows){
          const key = normalizePlate(r.plate);
          counts[key] = (counts[key] || 0) + 1;
          if (!plateForms[key]) plateForms[key] = [];
          plateForms[key].push(String(r.plate||"").trim());
        }
        const agg = [];
        for (const r of rows){
          const key = normalizePlate(r.plate);
          if (counts[key] > 1){
            const displayPlate = mostCommonNonEmpty(plateForms[key]) || key;
            const displayName  = bestNameByPlate[key] || "";
            agg.push({ plate: displayPlate, name: displayName, count: counts[key], key });
            counts[key] = -9999;
          }
        }
        agg.sort((a,b)=> b.count - a.count || a.plate.localeCompare(b.plate));

        html += `<div class="meta">Plates listed: ${agg.length}</div>`;
        html += `<table><thead><tr>
                  <th>License Plate</th><th>Driver Name</th><th>Offences</th>
                </tr></thead><tbody>`;
        for (const row of agg){
          html += `<tr>
                    <td>${escapeHtml(row.plate)}</td>
                    <td>${escapeHtml(row.name || "")}</td>
                    <td>${row.count}</td>
                  </tr>`;
        }
        html += `</tbody></table>`;
      } else {
        html += `<div class="meta">Rows: ${rows.length}</div>`;
        html += `<table><thead><tr>
                  <th>Timestamp</th>
                  <th>License Plate</th>
                  <th>Driver Name</th>
                  <th>Reason</th>
                  <th>Location</th>
                  <th>Hang Tag</th>
                  <th>Enforcer</th>
                  <th>Status</th>
                </tr></thead><tbody>`;
        for (const r of rows){
          const st = normalizeStatus(r.status);
          const cls = st === "Paid" ? "paid" : st === "Excempt" ? "excempt" : "unpaid";
          html += `<tr>
                    <td>${escapeHtml(formatDate(r.timestamp))}</td>
                    <td>${escapeHtml(r.plate)}</td>
                    <td>${escapeHtml(r.name)}</td>
                    <td>${escapeHtml(r.reason)}</td>
                    <td>${escapeHtml(r.location || "")}</td>
                    <td>${escapeHtml(r.hangtag || "")}</td>
                    <td>${escapeHtml(r.enforcer || "")}</td>
                    <td><span class="badge ${cls}">${st}</span></td>
                  </tr>`;
        }
        html += `</tbody></table>`;
      }

      html += `</body></html>`;
      win.document.open(); win.document.write(html); win.document.close();
      win.onload = () => { win.focus(); win.print(); };
      printModal.classList.add("hidden");
    });

    // Events
    document.getElementById("btnReload").addEventListener("click", loadFromCsv);
    document.getElementById("btnSearch").addEventListener("click", runSearch);
    document.getElementById("btnClear").addEventListener("click", () => {
      plateQuery.value=""; nameQuery.value="";
      statusFilter.value="all";
      lotFilter.value="all";
      repeatFilter.value="all";
      dateFromEl.value = "";
      dateToEl.value = "";
      hangQuery.value = "";
      resultsBody.innerHTML="";
      resultsWrap.classList.add("hidden");
      overallWrap.classList.add("hidden");
      statMatches.textContent=0; statCount.textContent=0;
    });
    statusFilter.addEventListener("change", runSearch);
    lotFilter.addEventListener("change", runSearch);
    repeatFilter.addEventListener("change", () => {
      if (isAdmin && repeatFilter.value === 'repeat') renderHeaderAggregated();
      else renderHeaderDetailed();
      runSearch();
    });
    document.getElementById("btnApplyDates").addEventListener("click", runSearch);
    plateQuery.addEventListener("keyup", e => { if (e.key==="Enter") runSearch(); });
    nameQuery.addEventListener("keyup", e => { if (e.key==="Enter") runSearch(); });
    hangQuery.addEventListener("keyup", e => { if (e.key==="Enter") runSearch(); });

    // Init
    renderHeaderDetailed();
    updateAdminUI();                  // start locked
    loadFromCsv();                    // first load
    setInterval(loadFromCsv, 60000);  // auto-refresh every 1 minute
    setInterval(updateLastUpdatedDisplay, 1000);
    checkAccessGate();
    setInterval(checkAccessGate, 30000);
    setInterval(updateGateNowLabel, 1000);
  </script>
</body>
</html>
