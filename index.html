<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Parking Violations Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* subtle toast */
    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(31, 41, 55, 0.95);
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.7);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 12px;
      z-index: 10000;
      display: none;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100" oncontextmenu="return false;">

  <!-- ACCESS GATE OVERLAY -->
  <div id="accessGate" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/80"></div>
    <div class="relative z-10 h-full w-full flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-gray-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-semibold text-white">Access Restricted</h2>
        <p class="text-sm text-gray-300 mt-2">
          This site is available between <span class="font-medium">7:45 AM</span> and
          <span class="font-medium">3:15 PM</span> Eastern. Please try again during those hours.
        </p>
        <div class="mt-5">
          <label for="gatePwd" class="block text-sm text-gray-200 mb-2">Admin override password</label>
          <input id="gatePwd" type="password" placeholder="Enter password"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
          <button id="gateUnlock"
                  class="mt-3 w-full rounded-lg bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700">
            Unlock
          </button>
          <div id="gateMsg" class="text-xs text-red-400 mt-2"></div>
        </div>
        <div class="mt-4 text-xs text-gray-400" id="gateNow"></div>
      </div>
    </div>
  </div>

  <!-- toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <div class="max-w-5xl mx-auto p-6" id="appRoot">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-white">Parking Violations Lookup</h1>
      <p class="text-sm text-gray-400 mt-1">
        Enter a license plate or driver name to see violations. Filter by status and date range.
      </p>
    </header>

    <!-- Status + Refresh + Enforcer Lock -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6">
      <div class="flex flex-col gap-3">
        <div class="flex items-center justify-between gap-4">
          <div>
            <div id="loadStatus" class="text-sm text-gray-400">Loading data...</div>
            <div id="lastUpdated" class="text-xs text-gray-500 mt-1"></div>
          </div>
          <button id="btnReload"
                  class="rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700">
            Reload
          </button>
        </div>

        <!-- Enforcer Lock Controls -->
        <div class="flex flex-wrap items-center gap-2">
          <span id="enforcerState" class="text-xs rounded-full px-2 py-1 bg-gray-700 text-gray-200">Enforcer: Hidden</span>
          <input id="enforcerPwd" type="password" placeholder="Enter password"
                 class="rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-emerald-500" />
          <button id="btnUnlock"
                  class="rounded-lg bg-blue-600 text-white px-3 py-2 text-sm font-medium hover:bg-blue-700">
            Unlock
          </button>
          <button id="btnLock"
                  class="rounded-lg bg-gray-600 text-white px-3 py-2 text-sm font-medium hover:bg-gray-500 hidden">
            Lock
          </button>
          <span id="enforcerMsg" class="text-xs text-red-400"></span>
        </div>
      </div>
    </section>

    <!-- Search + Filters -->
    <section class="bg-gray-800 rounded-xl shadow p-4 mb-6 hidden" id="searchSection">
      <div class="grid gap-3 md:grid-cols-6">
        <div class="md:col-span-2">
          <label for="plateQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by License Plate</label>
          <input id="plateQuery" type="text" placeholder="e.g., KS2-447"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div class="md:col-span-2">
          <label for="nameQuery" class="block text-sm font-medium text-gray-200 mb-2">Search by Driver Name</label>
          <input id="nameQuery" type="text" placeholder="e.g., John Doe"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div>
          <label for="statusFilter" class="block text-sm font-medium text-gray-200 mb-2">Filter by Status</label>
          <select id="statusFilter"
                  class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="btnSearch" class="w-full md:w-auto rounded-lg bg-blue-600 text-white px-4 py-2 font-medium hover:bg-blue-700">Search</button>
          <button id="btnClear"  class="w-full md:w-auto rounded-lg bg-gray-600 text-gray-100 px-4 py-2 font-medium hover:bg-gray-500">Clear</button>
        </div>
      </div>

      <!-- Date range row -->
      <div class="grid gap-3 md:grid-cols-6 mt-3">
        <div class="md:col-span-2">
          <label for="dateFrom" class="block text-sm font-medium text-gray-200 mb-2">From (date)</label>
          <input id="dateFrom" type="date"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div class="md:col-span-2">
          <label for="dateTo" class="block text-sm font-medium text-gray-200 mb-2">To (date)</label>
          <input id="dateTo" type="date"
                 class="w-full rounded-lg border border-gray-600 bg-gray-900 text-gray-100 px-3 py-2 focus:outline-none focus:ring focus:ring-emerald-500" />
        </div>
        <div class="md:col-span-2 flex items-end gap-2">
          <button id="btnApplyDates" class="w-full md:w-auto rounded-lg bg-purple-600 text-white px-4 py-2 font-medium hover:bg-purple-700">Apply Dates</button>
          <button id="btnClearDates" class="w-full md:w-auto rounded-lg bg-gray-600 text-gray-100 px-4 py-2 font-medium hover:bg-gray-500">Clear Dates</button>
        </div>
      </div>

      <!-- Overall paid/unpaid banner -->
      <div id="overallWrap" class="hidden mt-4">
        <div id="overallBadge" class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium"></div>
      </div>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <div class="bg-blue-900 rounded-lg p-3">
          <div class="text-xs text-blue-300">Records loaded</div>
          <div id="statRecords" class="text-xl font-semibold text-blue-100">0</div>
        </div>
        <div class="bg-green-900 rounded-lg p-3">
          <div class="text-xs text-green-300">Matches (after filters)</div>
          <div id="statMatches" class="text-xl font-semibold text-green-100">0</div>
        </div>
        <div class="bg-purple-900 rounded-lg p-3">
          <div class="text-xs text-purple-300">Violations for this query</div>
          <div id="statCount" class="text-xl font-semibold text-purple-100">0</div>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="resultsWrap" class="bg-gray-800 rounded-xl shadow p-4 hidden">
      <h2 class="text-lg font-semibold mb-3 text-gray-100">Results</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-700 text-gray-200">
            <tr id="resultsHeaderRow">
              <th class="text-left px-3 py-2">Timestamp</th>
              <th class="text-left px-3 py-2">License Plate</th>
              <th class="text-left px-3 py-2">Driver Name</th>
              <th class="text-left px-3 py-2">Reason for Citation</th>
              <th class="text-left px-3 py-2">Location</th>
              <!-- Enforcer header inserted if unlocked -->
              <th class="text-left px-3 py-2">Status</th>
            </tr>
          </thead>
          <tbody id="resultsBody" class="divide-y divide-gray-700"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // showToast for blocked actions
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => { toastEl.style.display = "none"; }, 1500);
    }

    // Stronger deterrents: block right-click, ctrl+click, common inspect shortcuts
    function blockCtx(e){ e.preventDefault(); showToast("Action disabled"); return false; }
    window.addEventListener("contextmenu", blockCtx, true);
    document.addEventListener("contextmenu", blockCtx, true);
    document.body?.addEventListener("contextmenu", blockCtx, true);

    function blockMouse(e){
      if (e.button === 2 || e.which === 3 || e.button === 1) {
        e.preventDefault(); showToast("Action disabled"); return false;
      }
      if (e.ctrlKey && (e.button === 0 || e.which === 1)) {
        e.preventDefault(); showToast("Action disabled"); return false;
      }
    }
    ["mousedown","mouseup","auxclick","pointerdown","pointerup"].forEach(type => {
      window.addEventListener(type, blockMouse, true);
      document.addEventListener(type, blockMouse, true);
    });

    document.addEventListener("keydown", function(e){
      const key = e.key.toLowerCase();
      const ctrl = e.ctrlKey || e.metaKey;
      const shift = e.shiftKey;
      if (e.keyCode === 123) { e.preventDefault(); showToast("Action disabled"); return; }
      if (ctrl && shift && ["i","j","c","k","p"].includes(key)) { e.preventDefault(); showToast("Action disabled"); return; }
      if (ctrl && key === "u") { e.preventDefault(); showToast("Action disabled"); return; }
    });

    try {
      const style = document.createElement("style");
      style.textContent = `
        * { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
      `;
      document.head.appendChild(style);
    } catch {}
  </script>

  <!-- keep rest of your JavaScript app code here (loading CSV, filters, enforcer unlock, access gate, etc.) -->
</body>
</html>
